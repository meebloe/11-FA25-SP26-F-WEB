<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory</title>
    <link rel="stylesheet" href="/css/style.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
</head>
<body>
<header>
    <img src="/images/cougar_mock-up.png" alt="Logo for WSU">
    <h1 onclick="window.location.href='/'">Voiland Food Pantry</h1>
</header>

<div class="main-content">
    <h2>Pantry Inventory</h2>

    <!-- Stats Box -->
    <div style="position: fixed; right: 20px; top: 100px; padding: 20px; border: 1px solid #ccc; border-radius: 5px; background: white; min-width: 200px;">
        <div style="margin-bottom: 20px;">
            <label>Total Weight of Food Given Out:</label><br>
            <div style="font-size: 24px; margin-top: 5px;">
                <span id="totalWeight">0</span> oz
            </div>
        </div>
        <button onclick="clearCheckouts()" style="width: 100%; padding: 10px;">Clear Checkouts</button>
    </div>

    <form method="get" action="/inventory" style="margin-bottom: 20px;">
        <input type="text" name="search" placeholder="Search by product name" th:value="${search}">
        <button type="submit">Search</button>
        <button type="button" onclick="window.location.href='/inventory'">Clear</button>
    </form>

    <table class="inventory-table">
        <tr>
            <th>ID</th>
            <th>UPC</th>
            <th>Product Name</th>
            <th>Net Weight (oz)</th>
            <th>Quantity</th>
            <th>Actions</th>
        </tr>
        <tr th:each="item : ${inventory}">
            <td th:text="${item.id}"></td>
            <td th:text="${item.upc}"></td>
            <td th:text="${item.productName}"></td>
            <td th:text="${item.netWeight}"></td>
            <td th:text="${item.quantity}"></td>
            <td>
                <a th:href="@{'/inventory/delete/' + ${item.id}}" class="delete-btn">Delete</a>
            </td>
        </tr>
    </table>

    <button type="button" onclick="openCheckoutPopup()" style="margin-left: 10px;">Checkout</button>
    <button type="button" onclick="openScanInPopup()" style="margin-left: 10px;">Scan In</button>

    <div class="back-btn-wrapper">
        <button onclick="window.location.href='/'">Back to Home</button>
    </div>
</div>

<!-- Checkout Popup -->
<div id="checkoutPopup" style="display: none; position: fixed; left: 50%; top: 50%; transform: translate(-50%, -50%); 
    background-color: white; padding: 20px; border: 1px solid #ccc; box-shadow: 0 0 10px rgba(0,0,0,0.5); z-index: 1000;">
    <h3>Checkout Item</h3>
    <form id="checkoutForm" onsubmit="handleCheckout(event)">
        <label>Product Code:</label><br>
        <input type="text" id="productCode" required><br><br>
        <button type="button" onclick="closeCheckoutPopup()">Cancel</button>
    </form>
</div>

<!-- Scan In Popup -->
<div id="scanInPopup" style="display: none; position: fixed; left: 50%; top: 50%; transform: translate(-50%, -50%); 
    background-color: white; padding: 20px; border: 1px solid #ccc; box-shadow: 0 0 10px rgba(0,0,0,0.5); z-index: 1000;">
    <h3>Scan In Item</h3>
    <form id="scanInForm" onsubmit="handleScanIn(event)">
        <label>Product Code:</label><br>
        <input type="text" id="scanInCode" required><br><br>

        <div id="scanInDetails" style="display:none; margin-top:10px;">
            <p>No existing item found â€” create new item:</p>
            <label>Product Name:</label><br>
            <input type="text" id="scanInProductName" required><br>
            <label>Net Weight (oz):</label><br>
            <input type="number" id="scanInNetWeight" step="0.01" required><br><br>
        </div>

        <button type="submit">Submit</button>
        <button type="button" onclick="closeScanInPopup()">Cancel</button>
    </form>
</div>

<script>
/* --- Checkout Functions --- */
function openCheckoutPopup() {
    const popup = document.getElementById('checkoutPopup');
    const input = document.getElementById('productCode');
    popup.style.display = 'block';
    input.focus();
    input.select();
    if (window.checkoutDebounce) clearTimeout(window.checkoutDebounce);
}

function closeCheckoutPopup() {
    document.getElementById('checkoutPopup').style.display = 'none';
    document.getElementById('productCode').value = '';
    if (window.checkoutDebounce) clearTimeout(window.checkoutDebounce);
}

function submitCheckout() {
    const code = document.getElementById('productCode').value.trim();
    if (!code) return;
    fetch('/inventory/checkout', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ code })
    })
    .then(async resp => {
        if (resp.ok) {
            const data = await resp.json();
            document.querySelectorAll('table tr').forEach((row, i) => {
                if (i === 0) return;
                const cells = row.children;
                if (cells[1].textContent.trim() === code) {
                    cells[4].textContent = data.newQuantity;
                }
            });
            closeCheckoutPopup();
            // Update total weight after successful checkout
            updateTotalWeight();
        } else {
            const err = await resp.json().catch(() => null);
            alert('Checkout failed: ' + (err?.message || 'Unknown error'));
        }
    }).catch(e => alert('Checkout request failed'));
}

function handleCheckout(e) {
    e.preventDefault();
    submitCheckout();
}

// Add listeners when DOM is ready: submit on Enter, and auto-submit after short pause (debounce)
// Function to update the total weight display
function updateTotalWeight() {
    fetch('/api/checkouts/weight-total')
        .then(response => response.json())
        .then(data => {
            document.getElementById('totalWeight').textContent = data.totalWeight.toFixed(2);
        })
        .catch(error => {
            console.error('Error fetching total weight:', error);
        });
}

// Function to clear all checkouts
function clearCheckouts() {
    if (!confirm('Are you sure you want to clear all checkout records?')) return;
    
    fetch('/api/checkouts/clear', {
        method: 'DELETE'
    })
        .then(response => response.json())
        .then(data => {
            updateTotalWeight(); // Reset the weight display
            alert('All checkouts have been cleared');
        })
        .catch(error => {
            console.error('Error clearing checkouts:', error);
            alert('Failed to clear checkouts');
        });
}

document.addEventListener('DOMContentLoaded', function () {
    // Initial load of total weight
    updateTotalWeight();
    
    const input = document.getElementById('productCode');
    if (!input) return;
    input.addEventListener('keydown', e => { if(e.key==='Enter'){ e.preventDefault(); submitCheckout(); }});
    input.addEventListener('input', function() {
        if (window.checkoutDebounce) clearTimeout(window.checkoutDebounce);
        if (!this.value) return;
        window.checkoutDebounce = setTimeout(submitCheckout, 250);
    });
});

/* --- Scan In Functions --- */
function openScanInPopup() {
    const popup = document.getElementById('scanInPopup');
    const input = document.getElementById('scanInCode');
    const details = document.getElementById('scanInDetails');
    popup.style.display = 'block';
    details.style.display = 'none';
    document.getElementById('scanInProductName').value = '';
    document.getElementById('scanInNetWeight').value = '';
    input.focus();
    input.select();
    if (window.scanInDebounce) clearTimeout(window.scanInDebounce);
}

function closeScanInPopup() {
    document.getElementById('scanInPopup').style.display = 'none';
    document.getElementById('scanInCode').value = '';
    document.getElementById('scanInProductName').value = '';
    document.getElementById('scanInNetWeight').value = '';
    if (window.scanInDebounce) clearTimeout(window.scanInDebounce);
}

function submitScanIn() {
    const code = document.getElementById('scanInCode').value.trim();
    if (!code) return;

    fetch('/inventory/scanin', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ code })
    })
    .then(async resp => {
        if (resp.ok) {
            const data = await resp.json();
            document.querySelectorAll('table tr').forEach((row, i) => {
                if(i===0) return;
                const cells = row.children;
                if(cells[1].textContent.trim() === code) cells[4].textContent = data.newQuantity;
            });
            closeScanInPopup();
        } else if (resp.status===404) {
            document.getElementById('scanInDetails').style.display='block';
            setTimeout(() => document.getElementById('scanInProductName').focus(), 50);
        } else {
            const err = await resp.json().catch(()=>null);
            alert('Scan In failed: ' + (err?.message || 'Unknown error'));
        }
    })
    .catch(e=>alert('Scan In request failed'));
}

function handleScanIn(e) {
    e.preventDefault();
    const detailsVisible = document.getElementById('scanInDetails').style.display !== 'none';
    if(detailsVisible){
        const name = document.getElementById('scanInProductName').value.trim();
        const netWeight = document.getElementById('scanInNetWeight').value;
        if(!name){ alert('Enter product name'); return; }
        if(!netWeight){ alert('Enter net weight'); return; }
        const code = document.getElementById('scanInCode').value.trim();
        fetch('/inventory/scanin', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ code, productName: name, netWeight: parseFloat(netWeight) })
        })
        .then(async resp => { if(resp.ok||resp.status===201) window.location.reload(); })
        .catch(e=>alert('Create request failed'));
    } else submitScanIn();
}

document.addEventListener('DOMContentLoaded', () => {
    const input = document.getElementById('scanInCode');
    if(!input) return;
    input.addEventListener('keydown', e => { if(e.key==='Enter'){ e.preventDefault(); submitScanIn(); }});
    input.addEventListener('input', function(){
        if(window.scanInDebounce) clearTimeout(window.scanInDebounce);
        if(!this.value) return;
        window.scanInDebounce = setTimeout(submitScanIn, 250);
    });
});
</script>

<footer></footer>
</body>
</html>
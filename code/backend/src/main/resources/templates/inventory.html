<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory</title>
    <link rel="stylesheet" href="/css/style.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
</head>
<body>
<header>
    <img src="/images/cougar_mock-up.png" alt="Logo for WSU">
    <h1 onclick="window.location.href='/'">Voiland Food Pantry</h1>
</header>

<div class="main-content">
    <h2>Pantry Inventory</h2>

    <!-- Stats Box -->
    <div style="position: fixed; right: 20px; top: 100px; padding: 20px; border: 1px solid #ccc; border-radius: 5px; background: white; min-width: 200px;">
        <div style="margin-bottom: 20px;">
            <label>Total Weight of Food Given Out:</label><br>
            <div style="font-size: 24px; margin-top: 5px;">
                <span id="totalWeight">0</span> oz
            </div>
        </div>
        <button onclick="clearCheckouts()" style="width: 100%; padding: 10px;">Clear Checkouts</button>
    </div>

    <form method="get" action="/inventory" style="margin-bottom: 20px;">
        <input type="text" name="search" placeholder="Search by product name" th:value="${search}">
        <button type="submit">Search</button>
        <button type="button" onclick="window.location.href='/inventory'">Clear</button>
    </form>

    <table class="inventory-table">
        <tr>
            <th>ID</th>
            <th>UPC</th>
            <th>Product Name</th>
            <th>Net Weight (oz)</th>
            <th>Quantity</th>
            <th>Actions</th>
        </tr>
        <tr th:each="item : ${inventory}">
            <td th:text="${item.id}"></td>
            <td th:text="${item.upc}"></td>
            <td th:text="${item.productName}"></td>
            <td th:text="${item.netWeight}"></td>
            <td th:text="${item.quantity}"></td>
            <td>
                <a th:href="@{'/inventory/delete/' + ${item.id}}" class="delete-btn">Delete</a>
            </td>
        </tr>
    </table>

    <button type="button" onclick="openCheckoutPopup()" style="margin-left: 10px;">Checkout</button>
    <button type="button" onclick="openScanInPopup()" style="margin-left: 10px;">Scan In</button>

    <div class="back-btn-wrapper">
        <button onclick="window.location.href='/'">Back to Home</button>
    </div>
</div>

<!-- Checkout Popup -->
<div id="checkoutPopup" style="display: none; position: fixed; left: 50%; top: 50%; transform: translate(-50%, -50%); 
    background-color: white; padding: 20px; border: 1px solid #ccc; box-shadow: 0 0 10px rgba(0,0,0,0.5); z-index: 1000;">
    <h3>Checkout Item</h3>
    <form id="checkoutForm" onsubmit="handleCheckout(event)">
        <label>Product Code:</label><br>
        <input type="text" id="productCode" required><br><br>
        <button type="button" onclick="closeCheckoutPopup()">Cancel</button>
    </form>
</div>

<!-- Scan In Popup -->
<div id="scanInPopup" style="display: none; position: fixed; left: 50%; top: 50%; transform: translate(-50%, -50%); 
    background-color: white; padding: 20px; border: 1px solid #ccc; box-shadow: 0 0 10px rgba(0,0,0,0.5); z-index: 1000;">
    <h3>Scan In Item</h3>
    <form id="scanInForm" onsubmit="handleScanIn(event)">
        <label>Product Code:</label><br>
        <input type="text" id="scanInCode" required><br><br>

        <!-- For existing items: show quantity field -->
        <div id="scanInExistingItem" style="display:none; margin-top:10px;">
            <p id="scanInExistingItemName"></p>
            <label>Quantity:</label><br>
            <input type="number" id="scanInQuantity" min="1" value="1" required><br><br>
        </div>

        <!-- For new items: show product details and quantity fields -->
        <div id="scanInNewItem" style="display:none; margin-top:10px;">
            <p>No existing item found â€” create new item:</p>
            <label>Product Name:</label><br>
            <input type="text" id="scanInProductName" required><br>
            <label>Net Weight (oz):</label><br>
            <input type="number" id="scanInNetWeight" step="0.01" required><br>
            <label>Quantity:</label><br>
            <input type="number" id="scanInQuantityNew" min="1" value="1" required><br><br>
        </div>

        <button type="button" id="scanInSubmitBtn" onclick="handleScanIn(event)" style="display:none;">Submit</button>
        <button type="button" onclick="closeScanInPopup()">Cancel</button>
    </form>
</div>

<script>
/* --- Checkout Functions --- */
function openCheckoutPopup() {
    const popup = document.getElementById('checkoutPopup');
    const input = document.getElementById('productCode');
    popup.style.display = 'block';
    input.focus();
    input.select();
    if (window.checkoutDebounce) clearTimeout(window.checkoutDebounce);
}

function closeCheckoutPopup() {
    document.getElementById('checkoutPopup').style.display = 'none';
    document.getElementById('productCode').value = '';
    if (window.checkoutDebounce) clearTimeout(window.checkoutDebounce);
}

function submitCheckout() {
    const code = document.getElementById('productCode').value.trim();
    if (!code) return;
    fetch('/inventory/checkout', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ code })
    })
    .then(async resp => {
        if (resp.ok) {
            const data = await resp.json();
            document.querySelectorAll('table tr').forEach((row, i) => {
                if (i === 0) return;
                const cells = row.children;
                if (cells[1].textContent.trim() === code) {
                    cells[4].textContent = data.newQuantity;
                }
            });
            closeCheckoutPopup();
            // Update total weight after successful checkout
            updateTotalWeight();
        } else {
            const err = await resp.json().catch(() => null);
            alert('Checkout failed: ' + (err?.message || 'Unknown error'));
        }
    }).catch(e => alert('Checkout request failed'));
}

function handleCheckout(e) {
    e.preventDefault();
    submitCheckout();
}

// Add listeners when DOM is ready: submit on Enter, and auto-submit after short pause (debounce)
// Function to update the total weight display
function updateTotalWeight() {
    fetch('/api/checkouts/weight-total')
        .then(response => response.json())
        .then(data => {
            document.getElementById('totalWeight').textContent = data.totalWeight.toFixed(2);
        })
        .catch(error => {
            console.error('Error fetching total weight:', error);
        });
}

// Function to clear all checkouts
function clearCheckouts() {
    if (!confirm('Are you sure you want to clear all checkout records?')) return;
    
    fetch('/api/checkouts/clear', {
        method: 'DELETE'
    })
        .then(response => response.json())
        .then(data => {
            updateTotalWeight(); // Reset the weight display
            alert('All checkouts have been cleared');
        })
        .catch(error => {
            console.error('Error clearing checkouts:', error);
            alert('Failed to clear checkouts');
        });
}

document.addEventListener('DOMContentLoaded', function () {
    // Initial load of total weight
    updateTotalWeight();
    
    const input = document.getElementById('productCode');
    if (!input) return;
    input.addEventListener('keydown', e => { if(e.key==='Enter'){ e.preventDefault(); submitCheckout(); }});
    input.addEventListener('input', function() {
        if (window.checkoutDebounce) clearTimeout(window.checkoutDebounce);
        if (!this.value) return;
        window.checkoutDebounce = setTimeout(submitCheckout, 250);
    });
});

/* --- Scan In Functions --- */
function openScanInPopup() {
    const popup = document.getElementById('scanInPopup');
    const input = document.getElementById('scanInCode');
    const existingItem = document.getElementById('scanInExistingItem');
    const newItem = document.getElementById('scanInNewItem');
    const submitBtn = document.getElementById('scanInSubmitBtn');
    
    popup.style.display = 'block';
    existingItem.style.display = 'none';
    newItem.style.display = 'none';
    submitBtn.style.display = 'none';
    
    document.getElementById('scanInProductName').value = '';
    document.getElementById('scanInNetWeight').value = '';
    document.getElementById('scanInQuantity').value = '1';
    document.getElementById('scanInQuantityNew').value = '1';
    
    input.focus();
    input.select();
    if (window.scanInDebounce) clearTimeout(window.scanInDebounce);
}

function closeScanInPopup() {
    document.getElementById('scanInPopup').style.display = 'none';
    document.getElementById('scanInCode').value = '';
    document.getElementById('scanInProductName').value = '';
    document.getElementById('scanInNetWeight').value = '';
    document.getElementById('scanInQuantity').value = '1';
    document.getElementById('scanInQuantityNew').value = '1';
    if (window.scanInDebounce) clearTimeout(window.scanInDebounce);
}

function checkBarcode() {
    const code = document.getElementById('scanInCode').value.trim();
    if (!code) return;

    fetch('/inventory/barcodecheck', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ code })
    })
    .then(async resp => {
        const existingItem = document.getElementById('scanInExistingItem');
        const newItem = document.getElementById('scanInNewItem');
        const submitBtn = document.getElementById('scanInSubmitBtn');
        
        if (resp.ok) {
            // Barcode found - show quantity field
            const data = await resp.json();
            document.getElementById('scanInExistingItemName').textContent = 
                `Found: ${data.productName} (Current quantity: ${data.currentQuantity})`;
            existingItem.style.display = 'block';
            newItem.style.display = 'none';
            submitBtn.style.display = 'block';
            document.getElementById('scanInQuantity').focus();
        } else if (resp.status === 404) {
            // Barcode not found - show product details fields
            existingItem.style.display = 'none';
            newItem.style.display = 'block';
            submitBtn.style.display = 'block';
            document.getElementById('scanInProductName').focus();
        } else {
            const err = await resp.json().catch(() => null);
            alert('Barcode check failed: ' + (err?.message || 'Unknown error'));
        }
    })
    .catch(e => alert('Barcode check request failed'));
}

function handleScanIn(e) {
    e.preventDefault();
    const code = document.getElementById('scanInCode').value.trim();
    const existingItem = document.getElementById('scanInExistingItem');
    
    if (existingItem.style.display !== 'none') {
        // Existing item: use quantity from existing item field
        const quantity = parseInt(document.getElementById('scanInQuantity').value) || 1;
        console.log('Submitting existing item:', code, quantity);
        submitScanInRequest(code, quantity, null, null);
    } else {
        // New item: use product details and quantity
        const productName = document.getElementById('scanInProductName').value.trim();
        const netWeight = document.getElementById('scanInNetWeight').value;
        const quantity = parseInt(document.getElementById('scanInQuantityNew').value) || 1;
        
        if (!productName) {
            alert('Enter product name');
            return;
        }
        if (!netWeight) {
            alert('Enter net weight');
            return;
        }
        
        console.log('Submitting new item:', code, quantity, productName, netWeight);
        submitScanInRequest(code, quantity, productName, parseFloat(netWeight));
    }
}

function submitScanInRequest(code, quantity, productName, netWeight) {
    const payload = { code, quantity };
    if (productName) payload.productName = productName;
    if (netWeight !== null && netWeight !== undefined) payload.netWeight = netWeight;
    
    console.log('Sending payload to /inventory/scanin:', payload);
    
    fetch('/inventory/scanin', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    })
    .then(async resp => {
        console.log('Response status:', resp.status);
        if (resp.ok || resp.status === 201) {
            const data = await resp.json();
            console.log('Response data:', data);
            document.querySelectorAll('table tr').forEach((row, i) => {
                if (i === 0) return;
                const cells = row.children;
                if (cells[1].textContent.trim() === code) {
                    cells[4].textContent = data.newQuantity;
                }
            });
            closeScanInPopup();
            if (resp.status === 201) {
                window.location.reload();
            }
        } else {
            const err = await resp.json().catch(() => null);
            alert('Scan In failed: ' + (err?.message || 'Unknown error'));
        }
    })
    .catch(e => {
        console.error('Request error:', e);
        alert('Scan In request failed');
    });
}

document.addEventListener('DOMContentLoaded', () => {
    const input = document.getElementById('scanInCode');
    if (!input) return;
    
    input.addEventListener('keydown', e => { 
        if (e.key === 'Enter') { 
            e.preventDefault(); 
            checkBarcode(); 
        }
    });
    
    input.addEventListener('input', function () {
        if (window.scanInDebounce) clearTimeout(window.scanInDebounce);
        if (!this.value) return;
        window.scanInDebounce = setTimeout(checkBarcode, 250);
    });
});
</script>

<footer></footer>
</body>
</html>
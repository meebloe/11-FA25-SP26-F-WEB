<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>Welcome</title>
<link rel="stylesheet" href="/css/style.css">

<!-- Ding sound -->
<audio id="dingSound">
    <source src="/sounds/ding.mp3" type="audio/mpeg">
</audio>

<style>
body {
    font-family: Arial, Helvetica, sans-serif;
    background: #f4f6f8;
    margin: 0;
}

/* Back button */
#backHomeBtn {
    position: absolute;
    top: 20px;
    right: 20px;
    padding: 10px 18px;
    border: none;
    border-radius: 6px;
    background-color: #502c2c;
    color: white;
    cursor: pointer;
}
#backHomeBtn:hover { background:#3d1f1f; }

/* Card Layout — BIGGER */
.content-wrapper {
    max-width: 1100px;
    width: 90%;
    margin: 40px auto;
    background: white;
    padding: 50px;
    border-radius: 12px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.12);
}

h1 { text-align:center; }
p { text-align:center; color:#555; font-size:17px; }

/* Scanned list */
#scannedList {
    border: 2px dashed #ccc;
    padding: 25px;
    min-height: 100px;
    margin: 30px 0;
    background: #fafafa;
    border-radius: 8px;
    font-size:16px;
}

/* RED THEME BUTTONS */
.primary-btn {
    display:block;
    margin: 0 auto;
    padding:14px 30px;
    font-size:16px;
    background:#db3434;
    color:white;
    border:none;
    border-radius:6px;
    cursor:pointer;
}
.primary-btn:hover { background:#b92929; }

.done-btn {
    padding:14px 45px;
    font-size:18px;
    background:#db3434;
    color:white;
    border:none;
    border-radius:6px;
    cursor:pointer;
}
.done-btn:hover { background:#b92929; }

/* Submit section */
.submit-visit-container {
    margin-top:50px;
    text-align:center;
    border-top:1px solid #eee;
    padding-top:35px;
}

/* Popup modal */
#checkoutPopup {
    display:none;
    position:fixed;
    left:50%;
    top:50%;
    transform:translate(-50%,-50%);
    background:white;
    padding:35px;
    border-radius:12px;
    box-shadow:0 0 25px rgba(0,0,0,0.4);
    z-index:1000;
    width:340px;
}

/* Confirmation */
.confirmation-box {
    margin-top:15px;
    padding:15px;
    background:#eef9f1;
    border:1px solid #27ae60;
    display:none;
    border-radius:6px;
}
</style>
</head>

<body>

<button id="backHomeBtn" onclick="window.location.href='/'">← Back to Home</button>

<h1 th:if="${student}">
    Welcome back!</span>!
</h1>
<h1 th:unless="${student}" th:text="${message}">Welcome</h1>

<div class="content-wrapper">

<p>Add items to your visit by scanning or typing their product code below.</p>

<div id="scannedList">
    <p id="emptyMsg" style="color:#999;">No items scanned yet.</p>
</div>

<button type="button" onclick="openCheckoutPopup()" class="primary-btn">
    + Scan/Type Item
</button>

<div class="submit-visit-container">
<form method="POST" action="/end-visit" id="endVisitForm">
    <input type="hidden" name="items" id="finalItems">
    <button type="submit" class="done-btn">Submit Visit</button>
</form>
</div>

</div>

<!-- POPUP -->
<div id="checkoutPopup">

<h3>Add Item</h3>

<div id="inputSection">
<label>Product Code:</label><br>

<input type="text" id="productCode"
       style="font-size:18px;width:95%;margin-top:5px;"
       placeholder="Type here...">

<br><br>

<button type="button"
    onclick="lookupItem()"
    style="background:#db3434;color:white;border:none;
           padding:10px 18px;border-radius:5px;cursor:pointer;">
    Add
</button>

<button type="button"
    onclick="closeCheckoutPopup()"
    style="background:#eee;border:1px solid #ccc;
           padding:10px 18px;margin-left:10px;">
    Cancel
</button>
</div>

<div id="confirmationSection" class="confirmation-box">
<p>Found:
    <span id="foundItemName"
          style="font-weight:bold;color:#27ae60;"></span>
</p>

<button type="button"
    onclick="addItemToList()"
    style="background:#27ae60;color:white;border:none;
           padding:10px 18px;border-radius:5px;cursor:pointer;">
    Add
</button>

<button type="button"
    onclick="resetPopup()"
    style="background:transparent;border:none;color:#666;
           text-decoration:underline;margin-left:10px;cursor:pointer;">
    Cancel
</button>
</div>

<p id="errorStatus" style="color:red;font-size:13px;margin-top:10px;"></p>

</div>

<script>
let currentPendingItem = null;

function openCheckoutPopup(){
    resetPopup();
    document.getElementById('checkoutPopup').style.display='block';
    document.getElementById('productCode').focus();
}

function closeCheckoutPopup(){
    document.getElementById('checkoutPopup').style.display='none';
}

function resetPopup(){
    document.getElementById('productCode').value='';
    document.getElementById('errorStatus').textContent='';
    document.getElementById('confirmationSection').style.display='none';
    document.getElementById('inputSection').style.display='block';
    currentPendingItem=null;
}

function lookupItem(){
    const code=document.getElementById('productCode').value.trim();
    if(!code) return;

    fetch('/inventory/checkout',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({code:code})
    })
    .then(async resp=>{
        if(resp.ok){
            const data=await resp.json();
            showConfirmation(data);
        } else {
            document.getElementById('errorStatus')
                .textContent='Invalid scan. Please try again.';
        }
    })
    .catch(()=>{
        document.getElementById('errorStatus')
            .textContent='Error contacting inventory.';
    });
}

function showConfirmation(data){
    document.getElementById("dingSound").play().catch(()=>{});
    currentPendingItem=data;
    document.getElementById('foundItemName').textContent=data.productName;
    document.getElementById('inputSection').style.display='none';
    document.getElementById('confirmationSection').style.display='block';
}

function addItemToList(){
    if(!currentPendingItem) return;

    const emptyMsg=document.getElementById("emptyMsg");
    if(emptyMsg) emptyMsg.remove();

    const scannedList=document.getElementById("scannedList");
    const itemEntry=document.createElement("div");
    itemEntry.style.padding="5px 0";
    itemEntry.innerHTML=`✅ ${currentPendingItem.productName}`;
    scannedList.appendChild(itemEntry);

    const finalItems=document.getElementById("finalItems");
    finalItems.value = finalItems.value
        ? finalItems.value + ", " + currentPendingItem.productName
        : currentPendingItem.productName;

    closeCheckoutPopup();
}

document.getElementById('productCode')
.addEventListener('keydown',e=>{
    if(e.key==='Enter'){
        e.preventDefault();
        lookupItem();
    }
});
</script>

</body>
</html>
